package com.welab.lms.config;

import org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;
import org.springframework.boot.web.server.WebServerFactoryCustomizer;
import org.springframework.boot.web.servlet.ServletContextInitializer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import javax.servlet.ServletRegistration;

@Configuration
public class VulnerabilityConfig implements WebMvcConfigurer {

    // 1. 톰캣 자체의 '파일 목록 보여주기' 기능 활성화
    @Bean
    public WebServerFactoryCustomizer<TomcatServletWebServerFactory> servletContainerCustomizer() {
        return factory -> {
            factory.addContextCustomizers(context -> {
                org.apache.catalina.Wrapper defaultServlet = (org.apache.catalina.Wrapper) context.findChild("default");
                if (defaultServlet != null) {
                    defaultServlet.addInitParameter("listings", "true"); // 디렉터리 리스팅 활성화
                    defaultServlet.addInitParameter("readonly", "false"); // 파일 조작 가능성
                }
            });
        };
    }

    // 2. 리소스 매핑: /root/ 주소를 리눅스 실제 / 경로에 연결
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/root/**")
                .addResourceLocations("file:/");
    }

    // 3. [가장 중요] /root/ 경로의 제어권을 톰캣 기본 서블릿에게 강제로 넘김
    // 이렇게 해야 /static/은 스프링이 처리(이미지 복구)하고, /root/는 톰캣이 처리(리스트 출력)합니다.
    @Bean
    public ServletContextInitializer servletContextInitializer() {
        return servletContext -> {
            ServletRegistration defaultServlet = servletContext.getServletRegistration("default");
            if (defaultServlet != null) {
                // 기존 /static/ 등은 건드리지 않고 /root/ 경로만 추가로 매핑
                defaultServlet.addMapping("/root/*");
            }
        };
    }
}